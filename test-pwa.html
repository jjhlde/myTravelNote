<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API í…ŒìŠ¤íŠ¸ - 2ë‹¨ê³„ ì§€ì¹¨ ê²€ì¦</title>
    <script src="./config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .day-section {
            margin-bottom: 40px;
            border-left: 4px solid #ff6b6b;
            padding-left: 20px;
        }
        
        .day-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #ff6b6b;
        }
        
        .activity {
            background: #f8f9fa;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            border-left: 3px solid #007bff;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .activity-time {
            background: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .activity-type {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        
        .place-details {
            background: white;
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .place-photos {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .place-photos img {
            width: 100px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .place-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
        
        .rating {
            color: #ffc107;
            font-weight: bold;
        }
        
        .map-link {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .error {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .tips {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .tips h4 {
            color: #856404;
            margin-bottom: 5px;
        }
        
        .tips ul {
            margin-left: 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 20px 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-2px);
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .response-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .response-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }
        
        .json-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="trip-title">Gemini API 2ë‹¨ê³„ ì§€ì¹¨ í…ŒìŠ¤íŠ¸</h1>
            <p id="trip-meta">ğŸ“ 1ë‹¨ê³„ ëª©ì—… ë°ì´í„° â†’ 2ë‹¨ê³„ Gemini API í˜¸ì¶œ í…ŒìŠ¤íŠ¸</p>
        </div>
        
        <div class="content">
            <button class="test-button" id="test-button" onclick="testGeminiAPI()">
                ğŸ§ª Gemini API 2ë‹¨ê³„ ì§€ì¹¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            </button>
            
            <button class="test-button" id="test-data-button" onclick="testWithMockData()" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); margin-top: 15px;">
                ğŸ“ mock_first_step_resp.jsonë¡œ PWA ìƒì„± í…ŒìŠ¤íŠ¸
            </button>
            
            <button class="test-button" id="test-final-button" onclick="testWithFinalMockData()" style="background: linear-gradient(135deg, #00b894, #00cec9); margin-top: 15px;">
                ğŸš€ mock_resp.json(ìµœì¢…ì™„ì„±)ìœ¼ë¡œ ë°”ë¡œ PWA ìƒì„±
            </button>
            
            <div class="loading" id="loading" style="display: none;">
                ğŸ”„ Gemini API í˜¸ì¶œ ì¤‘...
            </div>
            
            <div class="response-container" id="response-container" style="display: none;">
                <div class="response-header">ğŸ“‹ Gemini API ì‘ë‹µ ê²°ê³¼:</div>
                <div class="json-output" id="json-output"></div>
            </div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="total-days">-</div>
                    <div>ì—¬í–‰ ì¼ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-activities">-</div>
                    <div>ì´ í™œë™</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="enriched-places">-</div>
                    <div>ìƒì„¸ ì •ë³´</div>
                </div>
            </div>
            
            <div id="daily-plans"></div>
        </div>
    </div>

    <script>
        // Mock ë°ì´í„° ë¡œë“œ
        async function loadMockData() {
            try {
                const response = await fetch('./mock_first_step_req.json');
                const mockData = await response.json();
                return mockData;
            } catch (error) {
                console.error('Mock ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                throw new Error('Mock ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // 2ë‹¨ê³„ ì§€ì¹¨ ë¡œë“œ
        async function loadSecondStepPrompt() {
            try {
                const response = await fetch('./prompts/second_step.txt');
                const promptText = await response.text();
                return promptText;
            } catch (error) {
                console.error('2ë‹¨ê³„ ì§€ì¹¨ ë¡œë“œ ì‹¤íŒ¨:', error);
                throw new Error('2ë‹¨ê³„ ì§€ì¹¨ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // Gemini API í˜¸ì¶œ
        async function callGeminiAPI(prompt, systemData) {
            if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                throw new Error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. config.js íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
            
            const requestBody = {
                contents: [{
                    parts: [{
                        text: prompt + '\n\nì…ë ¥ ë°ì´í„°:\n' + JSON.stringify(systemData, null, 2)
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                }
            };
            
            const response = await fetch(CONFIG.GEMINI_API_URL + '?key=' + CONFIG.GEMINI_API_KEY, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Gemini API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} - ${errorData}`);
            }
            
            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Gemini API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
            
            return data.candidates[0].content.parts[0].text;
        }
        
        // Google Places API ì—°ë™ ì„œë¹„ìŠ¤
        class PlaceEnrichmentService {
            constructor() {
                this.apiKey = CONFIG.GOOGLE_PLACES_API_KEY;
                this.cache = new Map();
                this.rateLimitDelay = 100;
            }

            async enrichTravelData(travelData) {
                console.log('ğŸŒ Places APIë¡œ ì—¬í–‰ ë°ì´í„° ë³´ê°• ì‹œì‘:', travelData);
                
                try {
                    const queryResult = this.extractNewStructurePlaceQueries(travelData);
                    console.log('ğŸ“ ë°œê²¬ëœ ì¥ì†Œ ì¿¼ë¦¬:', queryResult);
                    
                    // êµ¬ì¡°ê°€ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸ (ì´ì „ ë²„ì „ í˜¸í™˜ì„±)
                    const allQueries = queryResult.allQueries || queryResult;
                    const uniqueQueries = queryResult.uniqueQueries || queryResult;
                    
                    if (uniqueQueries.length === 0) {
                        console.log('âš ï¸ ì¥ì†Œ ì¿¼ë¦¬ê°€ ì—†ì–´ API í˜¸ì¶œì„ ê±´ë„ˆëœë‹ˆë‹¤');
                        return travelData;
                    }
                    
                    // ìºì‹œë¥¼ ìœ„í•´ ê³ ìœ  ì¿¼ë¦¬ë§Œ API í˜¸ì¶œ
                    const enrichedPlaces = await this.batchEnrichPlaces(uniqueQueries);
                    
                    // ìºì‹œì—ì„œ ëª¨ë“  ìœ„ì¹˜ì— ë°ì´í„° ì ìš©
                    const enrichedData = this.mergeNewStructurePlaceDataWithCache(travelData, allQueries, enrichedPlaces);
                    
                    console.log('âœ… Places API ë°ì´í„° ë³´ê°• ì™„ë£Œ');
                    return enrichedData;
                    
                } catch (error) {
                    console.error('âŒ Places API ì˜¤ë¥˜:', error);
                    return travelData;
                }
            }

            extractNewStructurePlaceQueries(travelData) {
                console.log('ğŸ” ì¬ê·€ í•¨ìˆ˜ë¡œ ëª¨ë“  placeQuery ì¶”ì¶œ ì¤‘...');
                
                // ì¬ê·€ í•¨ìˆ˜ë¡œ ëª¨ë“  placeQuery ì¶”ì¶œ
                function extractPlaceQueries(obj, result = [], currentPath = '', parentActivity = null) {
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => {
                            extractPlaceQueries(item, result, `${currentPath}[${index}]`, parentActivity);
                        });
                    } else if (obj && typeof obj === 'object') {
                        // í˜„ì¬ ê°ì²´ê°€ í™œë™ì¸ì§€ í™•ì¸
                        const currentActivity = obj.activityType ? obj : parentActivity;
                        
                        for (const key in obj) {
                            const value = obj[key];
                            const path = currentPath ? `${currentPath}.${key}` : key;

                            if (key === 'placeQuery' && value) {
                                let inferredType = 'general';
                                
                                // 1. ìƒìœ„ í™œë™ ê¸°ë°˜ ë¶„ë¥˜ (í•µì‹¬ ë¶„ë¥˜)
                                if (currentActivity?.activityType === 'meal') {
                                    inferredType = 'restaurant';
                                } else if (currentActivity?.activityType === 'transport') {
                                    inferredType = 'transport';
                                } else if (currentActivity?.activityType === 'attraction') {
                                    inferredType = 'attraction';
                                } else if (currentActivity?.activityType === 'shopping') {
                                    inferredType = 'shopping';
                                } else if (currentActivity?.activityType === 'rest') {
                                    inferredType = 'accommodation';
                                }
                                
                                // 2. dailyTips ì˜ì—­ì˜ spotsëŠ” ëª¨ë‘ 'spot' íƒ€ì…ìœ¼ë¡œ
                                if (path.includes('dailyTips') && path.includes('spots')) {
                                    inferredType = 'spot';
                                }

                                result.push({
                                    query: value.trim(),
                                    path: path,
                                    type: inferredType,
                                    activity: currentActivity?.activityName || 'Unknown'
                                });
                            } else {
                                extractPlaceQueries(value, result, path, currentActivity);
                            }
                        }
                    }
                    return result;
                }
                
                const allQueries = extractPlaceQueries(travelData);
                
                // ìºì‹œë¥¼ ìœ„í•œ ê³ ìœ  ì¿¼ë¦¬ ëª©ë¡ ìƒì„± (API í˜¸ì¶œìš©)
                const uniqueQueries = [];
                const seenQueries = new Set();
                
                allQueries.forEach(item => {
                    if (!seenQueries.has(item.query)) {
                        seenQueries.add(item.query);
                        uniqueQueries.push(item);
                    }
                });
                
                console.log(`ğŸ“Š ì´ ${allQueries.length}ê°œ ë°œê²¬, ê³ ìœ  ì¿¼ë¦¬ ${uniqueQueries.length}ê°œ (API í˜¸ì¶œìš©)`);
                console.log(`ğŸ”„ ìºì‹œ ì‹œìŠ¤í…œì„ í†µí•´ ${allQueries.length}ê°œ ìœ„ì¹˜ì— ëª¨ë‘ ë°ì´í„° ì ìš© ì˜ˆì •`);
                
                return { allQueries, uniqueQueries };
                
                // mainPlanì—ì„œ placeQuery ì¶”ì¶œ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
                if (travelData.mainPlan && travelData.mainPlan.dailyPlans) {
                    travelData.mainPlan.dailyPlans.forEach((day, dayIndex) => {
                        if (day.activities) {
                            day.activities.forEach((activity, actIndex) => {
                                // mainPlaceì—ì„œ ì¶”ì¶œ
                                if (activity.mainPlace && activity.mainPlace.placeQuery) {
                                    queries.push({
                                        query: activity.mainPlace.placeQuery.trim(),
                                        path: `mainPlan.dailyPlans[${dayIndex}].activities[${actIndex}].mainPlace`,
                                        type: activity.type || 'general'
                                    });
                                }
                                
                                // alternativePlacesì—ì„œ ì¶”ì¶œ
                                if (activity.alternativePlaces && Array.isArray(activity.alternativePlaces)) {
                                    activity.alternativePlaces.forEach((alt, altIndex) => {
                                        if (alt.placeQuery) {
                                            queries.push({
                                                query: alt.placeQuery.trim(),
                                                path: `mainPlan.dailyPlans[${dayIndex}].activities[${actIndex}].alternativePlaces[${altIndex}]`,
                                                type: activity.type || 'general'
                                            });
                                        }
                                    });
                                }
                                
                                // mealsì—ì„œ ì¶”ì¶œ
                                if (activity.meals && Array.isArray(activity.meals)) {
                                    activity.meals.forEach((meal, mealIndex) => {
                                        if (meal.placeQuery) {
                                            queries.push({
                                                query: meal.placeQuery.trim(),
                                                path: `mainPlan.dailyPlans[${dayIndex}].activities[${actIndex}].meals[${mealIndex}]`,
                                                type: 'meal'
                                            });
                                        }
                                    });
                                }
                                
                                // recommendedRestaurantsì—ì„œ ì¶”ì¶œ
                                if (activity.recommendedRestaurants && Array.isArray(activity.recommendedRestaurants)) {
                                    activity.recommendedRestaurants.forEach((restaurant, restIndex) => {
                                        if (restaurant.placeQuery) {
                                            queries.push({
                                                query: restaurant.placeQuery.trim(),
                                                path: `mainPlan.dailyPlans[${dayIndex}].activities[${actIndex}].recommendedRestaurants[${restIndex}]`,
                                                type: 'restaurant'
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                // accommodationsì—ì„œ ì¶”ì¶œ
                if (travelData.accommodations && Array.isArray(travelData.accommodations)) {
                    travelData.accommodations.forEach((acc, accIndex) => {
                        if (acc.placeQuery) {
                            queries.push({
                                query: acc.placeQuery.trim(),
                                path: `accommodations[${accIndex}]`,
                                type: 'accommodation'
                            });
                        }
                        
                        // accommodation alternatives
                        if (acc.alternatives && Array.isArray(acc.alternatives)) {
                            acc.alternatives.forEach((alt, altIndex) => {
                                if (alt.placeQuery) {
                                    queries.push({
                                        query: alt.placeQuery.trim(),
                                        path: `accommodations[${accIndex}].alternatives[${altIndex}]`,
                                        type: 'accommodation'
                                    });
                                }
                            });
                        }
                    });
                }
                
                return queries;
            }

            async batchEnrichPlaces(placeQueries) {
                const results = [];
                
                for (let i = 0; i < placeQueries.length; i++) {
                    const placeQuery = placeQueries[i];
                    
                    try {
                        if (this.cache.has(placeQuery.query)) {
                            console.log(`ğŸ“‹ ìºì‹œì—ì„œ ë¡œë“œ: ${placeQuery.query}`);
                            results.push({
                                ...placeQuery,
                                placeData: this.cache.get(placeQuery.query)
                            });
                            continue;
                        }
                        
                        console.log(`ğŸ” ì¥ì†Œ ê²€ìƒ‰: ${placeQuery.query} (íƒ€ì…: ${placeQuery.type})`);
                        const placeData = await this.searchAndEnrichPlace(placeQuery.query, placeQuery.type);
                        
                        this.cache.set(placeQuery.query, placeData);
                        
                        results.push({
                            ...placeQuery,
                            placeData: placeData
                        });
                        
                        if (i < placeQueries.length - 1) {
                            await this.delay(this.rateLimitDelay);
                        }
                        
                    } catch (error) {
                        console.error(`ğŸ’¥ ${placeQuery.query} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
                        results.push({
                            ...placeQuery,
                            placeData: this.createFallbackData(placeQuery.query)
                        });
                    }
                }
                
                return results;
            }

            async searchAndEnrichPlace(query, type = 'general') {
                try {
                    const searchResult = await this.textSearch(query, type);
                    if (!searchResult || !searchResult.place_id) {
                        throw new Error('ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    const placeDetails = await this.getPlaceDetails(searchResult.place_id, type);
                    return placeDetails;
                    
                } catch (error) {
                    console.warn(`âš ï¸ ${query} ê²€ìƒ‰ ì‹¤íŒ¨, í´ë°± ë°ì´í„° ì‚¬ìš©:`, error.message);
                    return this.createFallbackData(query);
                }
            }

            async textSearch(query, type = 'general') {
                let typeFilter = '';
                if (type === 'meal') {
                    typeFilter = '&type=restaurant|food|meal_takeaway';
                } else if (type === 'sightseeing') {
                    typeFilter = '&type=tourist_attraction|museum|amusement_park';
                } else if (type === 'accommodation') {
                    typeFilter = '&type=lodging';
                }
                
                // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ API í˜¸ì¶œ
                const url = `/api/places/textsearch?query=${encodeURIComponent(query)}&key=${this.apiKey}&language=ko${typeFilter}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Places API ì˜¤ë¥˜: ${data.error}`);
                }
                
                if (data.status !== 'OK' || !data.results || data.results.length === 0) {
                    throw new Error(`ì¥ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ${data.status}`);
                }
                
                return data.results[0];
            }

            async getPlaceDetails(placeId, type = 'general') {
                const essentialFields = [
                    'place_id', 'name', 'formatted_address', 'geometry',
                    'rating', 'user_ratings_total', 'photos', 'reviews', 'url'
                ].join(',');
                
                // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ API í˜¸ì¶œ
                const url = `/api/places/details?place_id=${placeId}&fields=${essentialFields}&key=${this.apiKey}&language=ko`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Places API ì˜¤ë¥˜: ${data.error}`);
                }
                
                if (data.status !== 'OK' || !data.result) {
                    throw new Error(`ì¥ì†Œ ìƒì„¸ì •ë³´ ì‹¤íŒ¨: ${data.status}`);
                }
                
                const place = data.result;
                const photos = this.generatePhotoUrls(place.photos, 3);
                
                return {
                    name: place.name || 'ì¥ì†Œëª… ì—†ìŒ',
                    address: place.formatted_address || 'ì£¼ì†Œ ì—†ìŒ',
                    rating: place.rating || null,
                    reviewCount: place.user_ratings_total || 0,
                    photos: photos,
                    mapLink: place.url || this.generateMapsUrl(place.geometry?.location),
                    placeId: place.place_id,
                    reviews: this.formatSimpleReviews(place.reviews)
                };
            }

            generatePhotoUrls(photos, maxCount = 3) {
                if (!photos || !Array.isArray(photos)) return [];
                
                return photos.slice(0, maxCount).map(photo => {
                    const maxWidth = 400;
                    return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=${maxWidth}&photoreference=${photo.photo_reference}&key=${this.apiKey}`;
                });
            }

            generateMapsUrl(location) {
                if (!location || !location.lat || !location.lng) return '';
                return `https://www.google.com/maps?q=${location.lat},${location.lng}`;
            }

            formatSimpleReviews(reviews) {
                if (!reviews || !Array.isArray(reviews)) return [];
                
                return reviews.slice(0, 2).map(review => ({
                    author: review.author_name || 'ìµëª…',
                    rating: review.rating || 0,
                    text: review.text ? (review.text.length > 80 ? review.text.substring(0, 80) + '...' : review.text) : '',
                    date: review.relative_time_description || ''
                }));
            }

            createFallbackData(originalQuery) {
                return {
                    name: originalQuery,
                    address: 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ',
                    rating: null,
                    reviewCount: 0,
                    photos: [],
                    mapLink: '',
                    placeId: null,
                    reviews: [],
                    fallback: true
                };
            }

            mergeNewStructurePlaceData(travelData, enrichedPlaces) {
                const result = JSON.parse(JSON.stringify(travelData));
                
                enrichedPlaces.forEach(enrichedPlace => {
                    const path = enrichedPlace.path;
                    const placeData = enrichedPlace.placeData;
                    
                    // placeQuery ê²½ë¡œë¥¼ placeDetails ê²½ë¡œë¡œ ë³€í™˜
                    const placeDetailsPath = path.replace('.placeQuery', '.placeDetails');
                    
                    // ê²½ë¡œë¥¼ ë”°ë¼ ë°ì´í„° ë³‘í•©
                    this.setNestedProperty(result, placeDetailsPath, placeData);
                });
                
                return result;
            }

            mergeNewStructurePlaceDataWithCache(travelData, allQueries, enrichedPlaces) {
                console.log('ğŸ”„ ìºì‹œ ì‹œìŠ¤í…œì„ í†µí•´ ë°ì´í„° ë³‘í•© ì‹œì‘');
                
                const result = JSON.parse(JSON.stringify(travelData));
                
                // ìºì‹œ Map ìƒì„± (query â†’ placeData)
                const placeCache = new Map();
                enrichedPlaces.forEach(enrichedPlace => {
                    placeCache.set(enrichedPlace.query, enrichedPlace.placeData);
                });
                
                console.log(`ğŸ“¦ ìºì‹œì— ${placeCache.size}ê°œ ì¥ì†Œ ë°ì´í„° ì €ì¥ë¨`);
                
                // ëª¨ë“  ì¿¼ë¦¬ ìœ„ì¹˜ì— ìºì‹œì—ì„œ ë°ì´í„° ì ìš©
                let appliedCount = 0;
                allQueries.forEach(queryItem => {
                    const cachedData = placeCache.get(queryItem.query);
                    if (cachedData) {
                        // placeQuery ê²½ë¡œë¥¼ placeDetails ê²½ë¡œë¡œ ë³€í™˜
                        const placeDetailsPath = queryItem.path.replace('.placeQuery', '.placeDetails');
                        
                        // ê²½ë¡œë¥¼ ë”°ë¼ ë°ì´í„° ë³‘í•©
                        this.setNestedProperty(result, placeDetailsPath, cachedData);
                        appliedCount++;
                        
                        console.log(`âœ… ìºì‹œ ì ìš©: ${queryItem.query} â†’ ${placeDetailsPath}`);
                    } else {
                        console.warn(`âš ï¸ ìºì‹œì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${queryItem.query}`);
                    }
                });
                
                console.log(`ğŸ¯ ì´ ${allQueries.length}ê°œ ìœ„ì¹˜ ì¤‘ ${appliedCount}ê°œì— ë°ì´í„° ì ìš© ì™„ë£Œ`);
                return result;
            }

            setNestedProperty(obj, path, value) {
                const keys = path.split('.');
                let current = obj;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    const key = keys[i];
                    
                    if (key.includes('[') && key.includes(']')) {
                        const [arrayKey, indexStr] = key.split('[');
                        const index = parseInt(indexStr.replace(']', ''));
                        
                        if (!current[arrayKey]) current[arrayKey] = [];
                        if (!current[arrayKey][index]) current[arrayKey][index] = {};
                        current = current[arrayKey][index];
                    } else {
                        if (!current[key]) current[key] = {};
                        current = current[key];
                    }
                }
                
                const lastKey = keys[keys.length - 1];
                current[lastKey] = value;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testGeminiAPI() {
            const button = document.getElementById('test-button');
            const loading = document.getElementById('loading');
            const responseContainer = document.getElementById('response-container');
            const jsonOutput = document.getElementById('json-output');
            
            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
                button.disabled = true;
                button.textContent = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...';
                loading.style.display = 'block';
                responseContainer.style.display = 'none';
                
                // 1. Mock ë°ì´í„° ë¡œë“œ
                console.log('1. Mock ë°ì´í„° ë¡œë“œ ì¤‘...');
                const mockData = await loadMockData();
                console.log('Mock ë°ì´í„°:', mockData);
                
                // 2. 2ë‹¨ê³„ ì§€ì¹¨ ë¡œë“œ
                console.log('2. 2ë‹¨ê³„ ì§€ì¹¨ ë¡œë“œ ì¤‘...');
                const prompt = await loadSecondStepPrompt();
                console.log('2ë‹¨ê³„ ì§€ì¹¨ ê¸¸ì´:', prompt.length);
                
                // 3. Gemini API í˜¸ì¶œ
                console.log('3. Gemini API í˜¸ì¶œ ì¤‘...');
                const apiResponse = await callGeminiAPI(prompt, mockData.systemData);
                console.log('Gemini API ì‘ë‹µ ê¸¸ì´:', apiResponse.length);
                
                // 4. API ì‘ë‹µ ì›ë¬¸ ì €ì¥ (localStorageì— ì›ë¬¸ ì €ì¥)
                const rawResponseKey = `raw_gemini_response_${Date.now()}`;
                localStorage.setItem(rawResponseKey, apiResponse);
                console.log('4. API ì‘ë‹µ ì›ë¬¸ ì €ì¥ ì™„ë£Œ:', rawResponseKey);
                
                // 5. JSON ì •ë¦¬ ë° íŒŒì‹±
                const cleanedResponse = cleanGeminiResponse(apiResponse);
                console.log('5. ì •ë¦¬ëœ ì‘ë‹µ:', cleanedResponse.substring(0, 200) + '...');
                
                let parsedJson;
                try {
                    parsedJson = JSON.parse(cleanedResponse);
                    console.log('5. JSON íŒŒì‹± ì„±ê³µ:', parsedJson);
                } catch (parseError) {
                    console.error('JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
                    console.error('ì›ë¬¸ ì‘ë‹µ ì²˜ìŒ 500ì:', apiResponse.substring(0, 500));
                    
                    // ì›ë¬¸ì„ localStorageì— ë” ì €ì¥
                    localStorage.setItem('last_failed_response', apiResponse);
                    throw new Error(`ì˜ëª»ëœ JSON í˜•ì‹: ${parseError.message}\n\nì›ë¬¸ ì‘ë‹µì´ localStorageì— '${rawResponseKey}' í‚¤ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
                
                // 6. Places APIë¡œ ë°ì´í„° ë³´ê°•
                console.log('6. Places API ë°ì´í„° ë³´ê°• ì¤‘...');
                const placeService = new PlaceEnrichmentService();
                const enrichedData = await placeService.enrichTravelData(parsedJson);
                console.log('6. Places API ë³´ê°• ì™„ë£Œ:', enrichedData);
                
                // 7. localStorageì— ì €ì¥
                const sessionId = 'test_' + Date.now();
                localStorage.setItem(`enriched_travel_${sessionId}`, JSON.stringify(enrichedData));
                console.log('7. localStorage ì €ì¥ ì™„ë£¼:', sessionId);
                
                // 8. ê²°ê³¼ í‘œì‹œ ë° í˜ì´ì§€ ì´ë™ ì˜µì…˜
                loading.style.display = 'none';
                responseContainer.style.display = 'block';
                
                jsonOutput.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 10px;">âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ!</h4>
                        <p style="color: #155724; margin-bottom: 10px;">2ë‹¨ê³„ Gemini API í˜¸ì¶œ ë° Places API ë³´ê°•ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <button onclick="viewEnrichedResult('${sessionId}')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸ“„ ë³´ê°•ëœ ë°ì´í„° ë³´ê¸°
                        </button>
                        <button onclick="viewRawResponse('${rawResponseKey}')" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸ“ API ì›ë¬¸ ë³´ê¸°
                        </button>
                        <button onclick="openTemplateTest('${sessionId}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸš€ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
                        </button>
                    </div>
                    <div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 300px; overflow-y: auto;">
${JSON.stringify(enrichedData, null, 2)}
                    </div>
                `;
                
                console.log('âœ… ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
                
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                
                loading.style.display = 'none';
                responseContainer.style.display = 'block';
                jsonOutput.textContent = `âŒ ì˜¤ë¥˜ ë°œìƒ:\n${error.message}`;
                jsonOutput.style.color = '#e53e3e';
                
            } finally {
                // ë²„íŠ¼ ë³µì›
                button.disabled = false;
                button.textContent = 'ğŸ§ª Gemini API 2ë‹¨ê³„ ì§€ì¹¨ í…ŒìŠ¤íŠ¸ ì‹¤í–‰';
            }
        }
        
        // ë³´ê°•ëœ ë°ì´í„° ë³´ê¸° í•¨ìˆ˜
        function viewEnrichedResult(sessionId) {
            const data = localStorage.getItem(`enriched_travel_${sessionId}`);
            if (data) {
                const jsonOutput = document.getElementById('json-output');
                jsonOutput.innerHTML = `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <h4>ğŸ“„ ë³´ê°•ëœ ë°ì´í„° (Session: ${sessionId})</h4>
                    </div>
                    <div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 400px; overflow-y: auto;">
${data}
                    </div>
                `;
            } else {
                alert('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // Gemini ì‘ë‹µ ì •ë¦¬ í•¨ìˆ˜
        function cleanGeminiResponse(response) {
            let cleaned = response.trim();
            
            // ```json ë¸”ë¡ ì œê±°
            if (cleaned.startsWith('```json')) {
                cleaned = cleaned.replace(/^```json\s*/, '');
            }
            if (cleaned.endsWith('```')) {
                cleaned = cleaned.replace(/\s*```$/, '');
            }
            
            // ```ë§Œ ìˆëŠ” ê²½ìš°ë„ ì œê±°
            if (cleaned.startsWith('```')) {
                cleaned = cleaned.replace(/^```\s*/, '');
            }
            if (cleaned.endsWith('```')) {
                cleaned = cleaned.replace(/\s*```$/, '');
            }
            
            return cleaned.trim();
        }
        
        // API ì›ë¬¸ ë³´ê¸° í•¨ìˆ˜
        function viewRawResponse(rawResponseKey) {
            const rawData = localStorage.getItem(rawResponseKey);
            if (rawData) {
                const jsonOutput = document.getElementById('json-output');
                jsonOutput.innerHTML = `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <h4>ğŸ“ API ì›ë¬¸ ì‘ë‹µ (Key: ${rawResponseKey})</h4>
                        <p style="font-size: 0.9em; color: #666;">ê¸¸ì´: ${rawData.length}ì</p>
                    </div>
                    <div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 400px; overflow-y: auto;">
${rawData}
                    </div>
                `;
            } else {
                alert('ì›ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // mock_first_step_resp.jsonì„ ì‚¬ìš©í•œ PWA ìƒì„± í…ŒìŠ¤íŠ¸
        async function testWithMockData() {
            const button = document.getElementById('test-data-button');
            const loading = document.getElementById('loading');
            const responseContainer = document.getElementById('response-container');
            const jsonOutput = document.getElementById('json-output');
            
            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
                button.disabled = true;
                button.textContent = 'ğŸ”„ mock_first_step_resp.json ë°ì´í„° ì²˜ë¦¬ ì¤‘...';
                loading.style.display = 'block';
                loading.textContent = '1ï¸âƒ£ mock_first_step_resp.json íŒŒì¼ ë¡œë“œ ì¤‘...';
                responseContainer.style.display = 'none';
                
                // 1. mock_first_step_resp.jsonì—ì„œ ë°ì´í„° ë¡œë“œ
                console.log('1. mock_first_step_resp.jsonì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...');
                const response = await fetch('./mock_first_step_resp.json');
                if (!response.ok) {
                    throw new Error(`mock_first_step_resp.json ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
                }
                const travelData = await response.json();
                console.log('1. ë¡œë“œëœ ë°ì´í„°:', travelData);
                
                // 2. Places APIë¡œ ë°ì´í„° ë³´ê°• (ì˜µì…˜)
                let enrichedData = travelData;
                if (CONFIG.GOOGLE_PLACES_API_KEY && CONFIG.GOOGLE_PLACES_API_KEY !== 'YOUR_GOOGLE_PLACES_API_KEY_HERE') {
                    loading.textContent = '2ï¸âƒ£ Google Places APIë¡œ ì¥ì†Œ ì •ë³´ ë³´ê°• ì¤‘...';
                    console.log('2. Places APIë¡œ ë°ì´í„° ë³´ê°• ì¤‘...');
                    const placeService = new PlaceEnrichmentService();
                    enrichedData = await placeService.enrichTravelData(travelData);
                    console.log('2. Places API ë³´ê°• ì™„ë£Œ:', enrichedData);
                } else {
                    loading.textContent = '2ï¸âƒ£ Places API í‚¤ê°€ ì—†ì–´ì„œ ë³´ê°• ìƒëµ ì¤‘...';
                    console.log('2. Places API í‚¤ê°€ ì—†ì–´ì„œ ë³´ê°• ìƒëµ');
                }
                
                // 3. ì„œë²„ë¡œ ì™„ì„±ëœ JSON ì „ì†¡í•˜ì—¬ mock_resp.json íŒŒì¼ë¡œ ì €ì¥
                loading.textContent = '3ï¸âƒ£ ì„œë²„ë¡œ ì™„ì„±ëœ JSON ì „ì†¡í•˜ì—¬ íŒŒì¼ ì €ì¥ ì¤‘...';
                console.log('3. ì„œë²„ë¡œ ì™„ì„±ëœ JSON ì „ì†¡ ì¤‘...');
                const saveResponse = await fetch('/api/save-mock-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(enrichedData)
                });
                
                const saveResult = await saveResponse.json();
                if (!saveResult.success) {
                    throw new Error(`íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: ${saveResult.error}`);
                }
                console.log('3. mock_resp.json íŒŒì¼ ì €ì¥ ì™„ë£Œ:', saveResult);
                
                const sessionId = 'mockdata_' + Date.now();
                
                // 4. ê²°ê³¼ í‘œì‹œ
                loading.textContent = 'âœ… ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ! ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤...';
                setTimeout(() => {
                    loading.style.display = 'none';
                    responseContainer.style.display = 'block';
                }, 1000);
                
                jsonOutput.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 10px;">âœ… mock_resp.json íŒŒì¼ ìƒì„± ì„±ê³µ!</h4>
                        <p style="color: #155724; margin-bottom: 10px;">Places APIë¡œ ë³´ê°•ëœ ë°ì´í„°ê°€ mock_resp.json íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <p style="color: #155724; margin-bottom: 15px;">ğŸ“‚ ì €ì¥ ìœ„ì¹˜: ${saveResult.filePath}</p>
                        <button onclick="viewMockRespFile()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸ“„ mock_resp.json ë‚´ìš© ë³´ê¸°
                        </button>
                        <button onclick="generatePWAFromMockResp()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸš€ PWA HTML ìƒì„±í•˜ê¸°
                        </button>
                        <button onclick="openTemplateTest('${sessionId}')" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ“‹ ê¸°ì¡´ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸
                        </button>
                    </div>
                    <div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 300px; overflow-y: auto;">
${JSON.stringify(enrichedData, null, 2)}
                    </div>
                `;
                
                console.log('âœ… mock_first_step_resp.json PWA ìƒì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
                
            } catch (error) {
                console.error('mock_first_step_resp.json í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                
                loading.style.display = 'none';
                responseContainer.style.display = 'block';
                jsonOutput.innerHTML = `
                    <div style="padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                        <h4>âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</h4>
                        <p style="margin: 10px 0;">${error.message}</p>
                        <p style="font-size: 0.9em; color: #856404;">mock_first_step_resp.json íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                
            } finally {
                // ë²„íŠ¼ ë³µì›
                button.disabled = false;
                button.textContent = 'ğŸ“ mock_first_step_resp.jsonë¡œ PWA ìƒì„± í…ŒìŠ¤íŠ¸';
            }
        }
        
        // mock_resp.json(ìµœì¢…ì™„ì„±)ìœ¼ë¡œ ë°”ë¡œ PWA ìƒì„± í…ŒìŠ¤íŠ¸
        async function testWithFinalMockData() {
            const button = document.getElementById('test-final-button');
            const loading = document.getElementById('loading');
            const responseContainer = document.getElementById('response-container');
            const jsonOutput = document.getElementById('json-output');
            
            try {
                // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
                button.disabled = true;
                button.textContent = 'ğŸ”„ ìµœì¢… ë°ì´í„°ë¡œ PWA ìƒì„± ì¤‘...';
                loading.style.display = 'block';
                loading.textContent = '1ï¸âƒ£ mock_resp.json íŒŒì¼ ë¡œë“œ ì¤‘...';
                responseContainer.style.display = 'none';
                
                // 1. mock_resp.jsonì—ì„œ ìµœì¢… ì™„ì„±ëœ ë°ì´í„° ë¡œë“œ
                console.log('1. mock_resp.jsonì—ì„œ ìµœì¢… ì™„ì„±ëœ ë°ì´í„° ë¡œë“œ ì¤‘...');
                const response = await fetch('./mock_resp.json');
                if (!response.ok) {
                    throw new Error(`mock_resp.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.status}`);
                }
                const finalTravelData = await response.json();
                console.log('1. ìµœì¢… ì™„ì„±ëœ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', finalTravelData);
                
                // 2. ì„¸ì…˜ ID ìƒì„± ë° localStorage ì§ì ‘ ì €ì¥
                loading.textContent = '2ï¸âƒ£ PWA ë°ì´í„° ì¤€ë¹„ ë° ì €ì¥ ì¤‘...';
                console.log('2. mock_resp.json ë°ì´í„°ë¥¼ localStorageì— ì§ì ‘ ì €ì¥');
                
                const sessionId = Date.now().toString();
                
                // mock_resp.json ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ localStorageì— ì €ì¥
                localStorage.setItem(`generatedApp_${sessionId}`, JSON.stringify(finalTravelData));
                console.log('2. localStorage ì €ì¥ ì™„ë£Œ:', `generatedApp_${sessionId}`);
                
                // 3. ê²°ê³¼ í‘œì‹œ
                loading.textContent = 'âœ… ìµœì¢… PWA ìƒì„± ì™„ë£Œ! ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤...';
                setTimeout(() => {
                    loading.style.display = 'none';
                    responseContainer.style.display = 'block';
                }, 1000);
                
                jsonOutput.innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 10px;">ğŸš€ ìµœì¢… ì™„ì„± PWA ìƒì„± ì„±ê³µ!</h4>
                        <p style="color: #155724; margin-bottom: 10px;">Places APIê°€ ì™„ë£Œëœ ìµœì¢… ë°ì´í„°ë¡œ PWAê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <p style="color: #155724; margin-bottom: 15px;">ğŸ“‚ ì„¸ì…˜ ID: ${sessionId}</p>
                        <button onclick="window.open('/templates/main-template.html?session=${sessionId}', '_blank')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸš€ ì™„ì„±ëœ PWA ë°”ë¡œ ì—´ê¸°
                        </button>
                        <button onclick="viewMockRespFile()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸ“„ ìµœì¢… JSON ë°ì´í„° ë³´ê¸°
                        </button>
                        <button onclick="openTemplateTest('${sessionId}')" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ“‹ í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸ ë¹„êµ
                        </button>
                    </div>
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all; font-size: 0.9em; max-height: 300px; overflow-y: auto;">
âœ… ìƒì„±ëœ PWA ì •ë³´:
â€¢ ì œëª©: ${finalTravelData.tripMeta ? finalTravelData.tripMeta.destination + ' ' + finalTravelData.tripMeta.duration : 'ì—¬í–‰ ê³„íš'}
â€¢ ëª©ì ì§€: ${finalTravelData.tripMeta ? finalTravelData.tripMeta.destination : 'ì—¬í–‰ì§€'} ğŸ‡²ğŸ‡´
â€¢ ê¸°ê°„: ${finalTravelData.tripMeta ? finalTravelData.tripMeta.duration : 'ì—¬í–‰ ê¸°ê°„'}
â€¢ ì¼ì •: ${finalTravelData.mainPlan ? finalTravelData.mainPlan.dailyPlans.length + 'ê°œ ì¼ì •' : 'ì¼ì • ì •ë³´ ì—†ìŒ'}
â€¢ ìƒì„± ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

ğŸ”— PWA URL: /templates/main-template.html?session=${sessionId}
                    </div>
                `;
                
                console.log('âœ… mock_resp.json ìµœì¢… PWA ìƒì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
                
            } catch (error) {
                console.error('ìµœì¢… mock_resp.json PWA ìƒì„± ì‹¤íŒ¨:', error);
                
                loading.style.display = 'none';
                responseContainer.style.display = 'block';
                jsonOutput.innerHTML = `
                    <div style="padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
                        <h4>âŒ ìµœì¢… PWA ìƒì„± ì‹¤íŒ¨</h4>
                        <p style="margin: 10px 0;">${error.message}</p>
                        <p style="font-size: 0.9em; color: #856404;">mock_resp.json íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                
            } finally {
                // ë²„íŠ¼ ë³µì›
                button.disabled = false;
                button.textContent = 'ğŸš€ mock_resp.json(ìµœì¢…ì™„ì„±)ìœ¼ë¡œ ë°”ë¡œ PWA ìƒì„±';
            }
        }
        
        // í…œí”Œë¦¿ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™
        function openTemplateTest(sessionId) {
            // ì„¸ì…˜ IDë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
            const url = `/template-test?session=${sessionId}`;
            window.open(url, '_blank');
        }
        
        // mock_resp.json íŒŒì¼ ë‚´ìš© ë³´ê¸°
        async function viewMockRespFile() {
            try {
                const response = await fetch('./mock_resp.json');
                if (!response.ok) {
                    throw new Error(`mock_resp.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.status}`);
                }
                const jsonData = await response.json();
                
                // ìƒˆ ì°½ì—ì„œ JSON ë°ì´í„° í‘œì‹œ
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>mock_resp.json ë‚´ìš©</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow: auto; }
                                h1 { color: #333; }
                            </style>
                        </head>
                        <body>
                            <h1>ğŸ“„ mock_resp.json íŒŒì¼ ë‚´ìš©</h1>
                            <pre>${JSON.stringify(jsonData, null, 2)}</pre>
                        </body>
                    </html>
                `);
            } catch (error) {
                alert(`íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // mock_resp.jsonìœ¼ë¡œ PWA HTML ìƒì„±
        async function generatePWAFromMockResp() {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'ğŸ”„ PWA ìƒì„± ì¤‘...';
                
                // mock_resp.json íŒŒì¼ ë¡œë“œ
                const response = await fetch('./mock_resp.json');
                if (!response.ok) {
                    throw new Error(`mock_resp.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.status}`);
                }
                const travelData = await response.json();
                console.log('PWA ìƒì„± ë°ì´í„°:', travelData);
                
                // ì„œë²„ë¡œ PWA ë°ì´í„° ì¤€ë¹„ ìš”ì²­ (localStorage ë°©ì‹)
                button.textContent = 'ğŸ—ï¸ ì„œë²„ì—ì„œ ë°ì´í„° ì¤€ë¹„ ì¤‘...';
                const pwaResponse = await fetch('/api/generate-pwa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(travelData)
                });
                
                const pwaResult = await pwaResponse.json();
                if (!pwaResult.success) {
                    throw new Error(`PWA ë°ì´í„° ì¤€ë¹„ ì‹¤íŒ¨: ${pwaResult.error}`);
                }
                
                console.log('âœ… PWA ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ:', pwaResult);
                
                // localStorageì— ì—¬í–‰ ë°ì´í„° ì €ì¥ (chatbot.js ë°©ì‹)
                button.textContent = 'ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œì— ë°ì´í„° ì €ì¥ ì¤‘...';
                localStorage.setItem(`generatedApp_${pwaResult.sessionId}`, JSON.stringify(pwaResult.travelData));
                
                // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ PWA ë§í¬ ì œê³µ
                const resultDiv = document.createElement('div');
                resultDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    z-index: 1000;
                    max-width: 500px;
                    text-align: center;
                `;
                
                resultDiv.innerHTML = `
                    <h3 style="color: #28a745; margin-bottom: 15px;">ğŸ‰ PWA ìƒì„± ì™„ë£Œ!</h3>
                    <p style="margin-bottom: 20px;">chatbot.js ë°©ì‹ìœ¼ë¡œ ì—¬í–‰ ë°ì´í„°ê°€ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        ğŸ“‚ ì„¸ì…˜ ID: ${pwaResult.sessionId}
                    </p>
                    <div style="margin-bottom: 20px;">
                        <a href="${pwaResult.pwaUrl}" target="_blank" 
                           style="display: inline-block; background: #007bff; color: white; padding: 12px 24px; 
                                  text-decoration: none; border-radius: 8px; margin-right: 10px;">
                            ğŸš€ ìƒì„±ëœ PWA ì—´ê¸°
                        </a>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: #6c757d; color: white; padding: 12px 24px; 
                                       border: none; border-radius: 8px; cursor: pointer;">
                            ë‹«ê¸°
                        </button>
                    </div>
                    <p style="font-size: 0.8em; color: #999;">
                        ì´ì œ í…œí”Œë¦¿ íŒŒì¼ì´ localStorage ë°ì´í„°ë¥¼ ì½ì–´ì„œ ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤.
                    </p>
                `;
                
                document.body.appendChild(resultDiv);
                
                button.disabled = false;
                button.textContent = originalText;
                
            } catch (error) {
                console.error('PWA ìƒì„± ì—ëŸ¬:', error);
                alert(`PWA ìƒì„± ì‹¤íŒ¨: ${error.message}`);
                const button = event.target;
                button.disabled = false;
                button.textContent = 'ğŸš€ PWA HTML ìƒì„±í•˜ê¸°';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Gemini API 2ë‹¨ê³„ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // API í‚¤ ì²´í¬
            if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                const responseContainer = document.getElementById('response-container');
                const jsonOutput = document.getElementById('json-output');
                
                responseContainer.style.display = 'block';
                jsonOutput.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                        <h4>âš ï¸ API í‚¤ ì„¤ì • í•„ìš”</h4>
                        <p style="margin: 10px 0;">Gemini API í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ <code>config.js</code> íŒŒì¼ì—ì„œ ë‹¤ìŒ API í‚¤ë“¤ì„ ì„¤ì •í•´ì£¼ì„¸ìš”:</p>
                        <ul style="margin-left: 20px;">
                            <li><strong>GEMINI_API_KEY</strong>: Google Gemini API í‚¤</li>
                            <li><strong>GOOGLE_PLACES_API_KEY</strong>: Google Places API í‚¤</li>
                        </ul>
                        <p style="margin-top: 15px; font-size: 0.9em;">API í‚¤ ì„¤ì • í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>