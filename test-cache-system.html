<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Places API ìºì‹œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ Places API ìºì‹œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
        <p>ë„ì¿„ ê²Œì„ì‡¼ ì—¬í–‰ ë°ì´í„°ì—ì„œ ì¤‘ë³µëœ ì¥ì†Œë“¤ì´ ì–´ë–»ê²Œ ìºì‹œ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
        
        <button onclick="testCacheSystem()">ğŸ§ª ìºì‹œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button onclick="clearConsole()">ğŸ—‘ï¸ ì½˜ì†” ì§€ìš°ê¸°</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µê³„</h2>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalQueries">-</div>
                <div class="stat-label">ì´ ë°œê²¬ëœ ì¥ì†Œ</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="uniqueQueries">-</div>
                <div class="stat-label">ê³ ìœ  ì¥ì†Œ (API í˜¸ì¶œ)</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="savedCalls">-</div>
                <div class="stat-label">ì ˆì•½ëœ API í˜¸ì¶œ</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="efficiency">-</div>
                <div class="stat-label">íš¨ìœ¨ì„± (%)</div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ ì½˜ì†” ë¡œê·¸</h2>
        <div class="console-output" id="consoleOutput">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ìœ„ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”...</div>
    </div>

    <script>
        let consoleOutput = [];
        
        function log(message) {
            consoleOutput.push(message);
            document.getElementById('consoleOutput').textContent = consoleOutput.join('\n');
        }
        
        function clearConsole() {
            consoleOutput = [];
            document.getElementById('consoleOutput').textContent = 'ì½˜ì†”ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤...';
        }

        // Mock Tokyo Game Show travel data with duplicate places
        const mockTravelData = {
            "tripPlan": {
                "dailyTips": [
                    {
                        "type": "tgs",
                        "spots": [
                            {
                                "name": "ë§ˆì¿ í•˜ë¦¬ ë©§ì„¸",
                                "placeQuery": "Makuhari Messe, Chiba"
                            }
                        ]
                    }
                ],
                "itinerary": [
                    {
                        "dayNumber": 1,
                        "activities": [
                            {
                                "activityType": "transport",
                                "transportation": {
                                    "options": [
                                        {
                                            "placeQuery": "Narita International Airport"
                                        }
                                    ]
                                }
                            },
                            {
                                "activityType": "meal",
                                "options": [
                                    {
                                        "placeQuery": "restaurants near Kaihin-Makuhari Station"
                                    }
                                ]
                            },
                            {
                                "activityType": "attraction",
                                "mainLocation": {
                                    "placeQuery": "Akihabara Electric Town"
                                },
                                "options": [
                                    {
                                        "placeQuery": "Yodobashi Camera Multimedia Akiba"
                                    },
                                    {
                                        "placeQuery": "Super Potato Akihabara"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "dayNumber": 2,
                        "activities": [
                            {
                                "activityType": "attraction",
                                "mainLocation": {
                                    "placeQuery": "Makuhari Messe International Exhibition Hall"
                                }
                            },
                            {
                                "activityType": "meal",
                                "options": [
                                    {
                                        "placeQuery": "Makuhari Messe food court"
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "dayNumber": 3,
                        "activities": [
                            {
                                "activityType": "transport",
                                "transportation": {
                                    "options": [
                                        {
                                            "placeQuery": "Narita International Airport"  // ì¤‘ë³µ!
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                ]
            }
        };

        // ìºì‹œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testCacheSystem() {
            log('ğŸš€ ìºì‹œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘...\n');
            
            const result = extractPlaceQueries(mockTravelData.tripPlan);
            
            log(`ğŸ“Š ë¶„ì„ ê²°ê³¼:`);
            log(`   ì´ ë°œê²¬ëœ ì¥ì†Œ: ${result.allQueries.length}ê°œ`);
            log(`   ê³ ìœ  ì¥ì†Œ ìˆ˜: ${result.uniqueQueries.length}ê°œ`);
            log(`   ì ˆì•½ëœ API í˜¸ì¶œ: ${result.allQueries.length - result.uniqueQueries.length}ê°œ`);
            log(`   íš¨ìœ¨ì„±: ${Math.round((1 - result.uniqueQueries.length / result.allQueries.length) * 100)}%\n`);
            
            log('ğŸ“ ë°œê²¬ëœ ëª¨ë“  ì¥ì†Œë“¤:');
            result.allQueries.forEach((item, index) => {
                log(`   ${index + 1}. ${item.query} (${item.type}) - ${item.path}`);
            });
            
            log('\nğŸ” ê³ ìœ  ì¥ì†Œë“¤ (ì‹¤ì œ API í˜¸ì¶œ ëŒ€ìƒ):');
            result.uniqueQueries.forEach((item, index) => {
                log(`   ${index + 1}. ${item.query} (${item.type})`);
            });
            
            log('\nğŸ’¾ ìºì‹œ ì ìš© ì˜ˆì‹œ:');
            const duplicates = result.allQueries.filter(q1 => 
                result.allQueries.some(q2 => q2 !== q1 && q2.query === q1.query)
            );
            
            if (duplicates.length > 0) {
                const duplicateGroups = {};
                duplicates.forEach(item => {
                    if (!duplicateGroups[item.query]) {
                        duplicateGroups[item.query] = [];
                    }
                    duplicateGroups[item.query].push(item.path);
                });
                
                Object.entries(duplicateGroups).forEach(([query, paths]) => {
                    log(`   "${query}" â†’ ${paths.length}ê°œ ìœ„ì¹˜ì— ìºì‹œ ì ìš©`);
                    paths.forEach(path => log(`     - ${path}`));
                });
            } else {
                log('   ì¤‘ë³µëœ ì¥ì†Œê°€ ì—†ì–´ ìºì‹œ í˜œíƒì´ ì œí•œì ì…ë‹ˆë‹¤.');
            }
            
            // Update statistics
            updateStats(result);
            
            log('\nâœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
        }

        function updateStats(result) {
            document.getElementById('totalQueries').textContent = result.allQueries.length;
            document.getElementById('uniqueQueries').textContent = result.uniqueQueries.length;
            document.getElementById('savedCalls').textContent = result.allQueries.length - result.uniqueQueries.length;
            
            const efficiency = Math.round((1 - result.uniqueQueries.length / result.allQueries.length) * 100);
            document.getElementById('efficiency').textContent = efficiency + '%';
        }

        // ì¥ì†Œ ì¿¼ë¦¬ ì¶”ì¶œ í•¨ìˆ˜ (ìºì‹œ ì‹œìŠ¤í…œ í¬í•¨)
        function extractPlaceQueries(travelData) {
            const allQueries = [];
            
            function extractRecursive(obj, currentPath = '', parentActivity = null) {
                if (Array.isArray(obj)) {
                    obj.forEach((item, index) => {
                        extractRecursive(item, `${currentPath}[${index}]`, parentActivity);
                    });
                } else if (obj && typeof obj === 'object') {
                    const currentActivity = obj.activityType ? obj : parentActivity;
                    
                    for (const key in obj) {
                        const value = obj[key];
                        const path = currentPath ? `${currentPath}.${key}` : key;

                        if (key === 'placeQuery' && value) {
                            let inferredType = 'general';
                            
                            if (currentActivity?.activityType === 'meal') {
                                inferredType = 'restaurant';
                            } else if (currentActivity?.activityType === 'transport') {
                                inferredType = 'transport';
                            } else if (currentActivity?.activityType === 'attraction') {
                                inferredType = 'attraction';
                            } else if (currentActivity?.activityType === 'shopping') {
                                inferredType = 'shopping';
                            }
                            
                            if (path.includes('dailyTips') && path.includes('spots')) {
                                inferredType = 'spot';
                            }
                            
                            allQueries.push({
                                query: value,
                                type: inferredType,
                                path: path
                            });
                        } else {
                            extractRecursive(value, path, currentActivity);
                        }
                    }
                }
            }
            
            extractRecursive(travelData);
            
            // ì¤‘ë³µ ì œê±°í•˜ì—¬ ê³ ìœ  ì¿¼ë¦¬ë§Œ ì¶”ì¶œ (API í˜¸ì¶œìš©)
            const uniqueQueries = [];
            const seenQueries = new Set();
            
            allQueries.forEach(item => {
                if (!seenQueries.has(item.query)) {
                    seenQueries.add(item.query);
                    uniqueQueries.push(item);
                }
            });
            
            return { allQueries, uniqueQueries };
        }
    </script>
</body>
</html>